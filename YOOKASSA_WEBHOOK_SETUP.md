# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –¥–ª—è YooKassa

## üìã –ß—Ç–æ —Ç–∞–∫–æ–µ Webhook?

Webhook - —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç YooKassa –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–µ–π. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç, YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä, –∏ –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏ –∑–∞—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ YooKassa

### 1. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa:
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**
- –í –ø–æ–ª–µ **Webhook URL** –≤–≤–µ–¥–∏—Ç–µ: `http://your-domain:8000/webhook/yookassa`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∫–ª—é—á–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è:
  - ‚úÖ `payment.succeeded` (–ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω)
  - ‚úÖ `payment.canceled` (–ø–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω)
  - ‚úÖ `payment.waiting_for_capture` (–ø–ª–∞—Ç–µ–∂ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
–í —Ñ–∞–π–ª–µ `.env` –¥–æ–±–∞–≤—å—Ç–µ:
```bash
YOOKASSA_ENABLED=true
YOOKASSA_SHOP_ID=your_shop_id
YOOKASSA_SECRET_KEY=your_secret_key
YOOKASSA_WEBHOOK_SECRET=your_webhook_secret

# –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏:
# YOOKASSA_SKIP_SIGNATURE_VERIFICATION=true
```

## üåê Webhook URL –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```
http://localhost:8000/webhook/yookassa
```

### –î–ª—è Docker (–ª–æ–∫–∞–ª—å–Ω–æ):
```
http://localhost:8000/webhook/yookassa
```

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (—Å –¥–æ–º–µ–Ω–æ–º):
```
https://yourdomain.com/webhook/yookassa
```

### –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å ngrok:
```
https://abc123.ngrok.io/webhook/yookassa
```

## üì° Endpoints Webhook —Å–µ—Ä–≤–µ—Ä–∞

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ webhook —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∞–¥—Ä–µ—Å–∞–º:

- **Webhook endpoint**: `POST /webhook/yookassa` - –æ—Å–Ω–æ–≤–Ω–æ–π endpoint –¥–ª—è YooKassa
- **Health check**: `GET /health` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞
- **Status**: `GET /webhook/yookassa/status` - —Å—Ç–∞—Ç—É—Å webhook —Å–µ—Ä–≤–µ—Ä–∞

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
‚úÖ YooKassa webhook server started at http://0.0.0.0:8000
üîó Webhook endpoint: http://0.0.0.0:8000/webhook/yookassa
üìä Health check: http://0.0.0.0:8000/health
üìà Status: http://0.0.0.0:8000/webhook/yookassa/status
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å webhook —Å–µ—Ä–≤–µ—Ä–∞:
```bash
curl http://localhost:8000/webhook/yookassa/status
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health check:
```bash
curl http://localhost:8000/health
```

### 3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- Webhook —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –æ—Ç YooKassa
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ firewall –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Ä—Ç—É 8000
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ `YOOKASSA_WEBHOOK_SECRET`

## ‚ùó –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### Webhook —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 8000 —Å–≤–æ–±–æ–¥–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö YooKassa
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏

### –û—à–∏–±–∫–∏ –ø–æ–¥–ø–∏—Å–∏:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `YOOKASSA_WEBHOOK_SECRET`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç YooKassa
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö webhook
4. –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏:
   ```bash
   YOOKASSA_SKIP_SIGNATURE_VERIFICATION=true
   ```
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∏

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è YooKassa –ø–æ webhook](https://yookassa.ru/developers/using-api/webhooks)
- [–ü—Ä–∏–º–µ—Ä—ã webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤](https://github.com/yoomoney/yookassa-python-sdk)
- [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook](https://yookassa.ru/developers/using-api/webhooks#test-webhook)
